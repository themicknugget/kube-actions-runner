# Default values for kube-actions-runner

### Image
image:
  # -- Container image repository for the webhook-scaler
  repository: ghcr.io/themicknugget/kube-actions-runner
  # -- Image tag (defaults to Chart appVersion if not set)
  tag: ""
  # -- Image pull policy
  pullPolicy: IfNotPresent

# -- Image pull secrets for private registries
imagePullSecrets: []

# -- Override the name of the chart
nameOverride: ""

# -- Override the full name of the chart
fullnameOverride: ""

### Deployment
# -- Number of webhook-scaler replicas
replicaCount: 1

### Config
config:
  # -- Runner mode: "standard", "userns", "dind", or "dind-rootless"
  runnerMode: "dind-rootless"

  # -- Label matchers for filtering workflow jobs (comma-separated)
  # Only jobs with ALL specified labels will trigger runner creation
  # Example: "self-hosted,linux,x64"
  labelMatchers: "self-hosted"

  # -- TTL in seconds for completed runner Jobs
  ttlSeconds: 300

  # -- GitHub runner group ID (optional, for organization runners)
  runnerGroupId: ""

  # -- Runner container image
  runnerImage: "ghcr.io/actions/actions-runner:2.321.0"

  # -- Docker-in-Docker sidecar image (if DinD is needed)
  dindImage: "docker:27-dind"

  # -- Listen address for the webhook server
  listenAddr: ":8080"

  # -- Skip node availability check for architecture labels
  # When false (default), jobs requiring specific architectures will only be created
  # if matching nodes are available. When true, jobs are always created regardless
  # of node availability.
  skipNodeCheck: false

### Webhook Auto-Registration
# When enabled, the scaler will automatically discover repositories with
# self-hosted runner workflows and register webhooks on them.
webhookAutoRegister:
  # -- Enable automatic webhook registration
  # When true, the scaler scans GitHub for repos with self-hosted workflows
  # and automatically creates/updates webhooks.
  enabled: false

  # -- The public URL where GitHub can reach the webhook endpoint
  # Required when webhookAutoRegister.enabled is true
  # Example: "https://kube-actions-runner.yourdomain.com/webhook"
  webhookURL: ""

  # -- How often to rescan for new repositories/workflows
  # Set to "0" to only scan on startup
  # Example: "1h", "30m", "6h"
  syncInterval: "1h"

### Secrets
secrets:
  # -- Use an existing secret instead of creating one
  # If set, the chart will not create a Secret resource
  existingSecret: ""

  # -- GitHub webhook secret for validating incoming webhook payloads
  # OPTIONAL when webhookAutoRegister.enabled is true (will be auto-generated)
  # REQUIRED when webhookAutoRegister.enabled is false
  webhookSecret: ""

  # -- GitHub token with permissions to create JIT runner configs
  # Required scopes for fine-grained PAT:
  #   - Actions: Read and write
  #   - Administration: Read and write
  #   - (If webhookAutoRegister.enabled) Webhooks: Read and write
  githubToken: ""

### Resources
resources:
  limits:
    cpu: 100m
    memory: 256Mi
  requests:
    cpu: 50m
    memory: 64Mi

### Service Account
serviceAccount:
  # -- Create a service account for the webhook-scaler
  create: true
  # -- Name of the service account (auto-generated if not set)
  name: ""
  # -- Annotations to add to the service account
  annotations: {}

### Service
service:
  # -- Service type
  type: ClusterIP
  # -- Service port
  port: 80
  # -- Target port on the container
  targetPort: 8080

### Pod
# -- Additional pod annotations
podAnnotations: {}

# -- Additional pod labels
podLabels: {}

# -- Pod security context
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65532
  runAsGroup: 65532
  fsGroup: 65532
  seccompProfile:
    type: RuntimeDefault

# -- Container security context
securityContext:
  allowPrivilegeEscalation: false
  readOnlyRootFilesystem: true
  capabilities:
    drop:
      - ALL

# -- Node selector for pod scheduling
nodeSelector: {}

# -- Tolerations for pod scheduling
tolerations: []

# -- Affinity rules for pod scheduling
affinity: {}

### Probes
livenessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 3
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /health
    port: http
  initialDelaySeconds: 2
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

### Metrics
metrics:
  serviceMonitor:
    # -- Create a ServiceMonitor for Prometheus Operator
    enabled: false
    # -- Additional labels for the ServiceMonitor
    labels: {}
    # -- Scrape interval
    interval: 30s
    # -- Scrape timeout
    scrapeTimeout: 10s
    # -- Metric path
    path: /metrics

### Cloudflare Tunnel (Optional)
cloudflare:
  # -- Enable Cloudflare Tunnel deployment for secure webhook ingress
  enabled: false

  # -- Cloudflare Tunnel ID
  tunnelId: ""

  # -- Cloudflared container image
  image: "cloudflare/cloudflared:2024.12.2"

  # -- Number of cloudflared replicas
  replicaCount: 1

  # -- Use existing secret for tunnel credentials
  # Secret should contain 'credentials.json' key
  existingSecret: ""

  # -- Resource limits for cloudflared
  resources:
    limits:
      memory: 128Mi
      cpu: 100m
    requests:
      memory: 64Mi
      cpu: 50m

### Cleanup CronJob (Optional)
cleanup:
  # -- Enable cleanup CronJob for orphaned runner jobs
  enabled: false

  # -- Cron schedule for cleanup job
  schedule: "*/5 * * * *"

  # -- kubectl image for cleanup job
  image: "bitnami/kubectl:1.31"

  # -- Age threshold in seconds for orphan detection (default 30 minutes)
  ageThresholdSeconds: 1800

  # -- Resource limits for cleanup job
  resources:
    limits:
      memory: 64Mi
      cpu: 50m
    requests:
      memory: 32Mi
      cpu: 10m

### Network Policies (Optional)
networkPolicies:
  # -- Enable network policies for webhook-scaler components
  enabled: false

  # -- Allow runner jobs to access any external endpoint
  # Set to false for stricter security (may break some workflows)
  allowRunnerEgress: true

### Pod Disruption Budget (Optional)
podDisruptionBudget:
  # -- Enable PodDisruptionBudget for webhook-scaler
  enabled: false

  # -- Minimum available pods (can be number or percentage)
  minAvailable: 1

  # -- Maximum unavailable pods (alternative to minAvailable)
  # maxUnavailable: 1
